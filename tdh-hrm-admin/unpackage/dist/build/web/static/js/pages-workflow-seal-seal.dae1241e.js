(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["pages-workflow-seal-seal"],{"2b5e":function(e,t,a){"use strict";a.r(t);var n=a("e8ff"),o=a.n(n);for(var r in n)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(r);t["default"]=o.a},"3e25":function(e,t,a){"use strict";a.d(t,"b",(function(){return o})),a.d(t,"c",(function(){return r})),a.d(t,"a",(function(){return n}));var n={dynamicFormDialog:a("5453").default,simulateHandleDialog:a("413d").default,filePreviewDialog:a("7cf48").default,approveHeaderDetail:a("57e1").default},o=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("v-uni-view",{staticClass:"page-body"},[a("vk-data-table-query",{attrs:{columns:e.queryForm1.columns},on:{search:function(t){arguments[0]=t=e.$handleEvent(t),e.search.apply(void 0,arguments)}},scopedSlots:e._u([{key:"dateRange",fn:function(){return[a("vk-data-input-date-time",{attrs:{type:"daterange"},model:{value:e.queryForm1.formData.dateRange,callback:function(t){e.$set(e.queryForm1.formData,"dateRange",t)},expression:"queryForm1.formData.dateRange"}})]},proxy:!0}]),model:{value:e.queryForm1.formData,callback:function(t){e.$set(e.queryForm1,"formData",t)},expression:"queryForm1.formData"}}),a("v-uni-view",{staticClass:"button-group"},[a("el-row",[e.$hasRole("admin")||e.$hasRole("group-common")?a("el-button",{attrs:{type:"success",size:"small",icon:"el-icon-circle-plus-outline",disabled:e.loading,loading:e.addLoading},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.addBtn.apply(void 0,arguments)}}},[e._v(" 新建用印申请 ")]):e._e(),a("el-button",{attrs:{type:"warning",size:"small",icon:"el-icon-refresh",loading:e.loading},on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.refresh.apply(void 0,arguments)}}},[e._v(" 刷新 ")])],1)],1),e.loading&&!e.formSchema?a("el-skeleton",{attrs:{rows:10,animated:!0}}):a("vk-data-table",{ref:"table1",attrs:{action:e.table1.action,columns:e.table1.columns,"query-form-param":e.queryForm1,"custom-right-btns":e.table1.customRightBtns,selection:!1,"row-no":!0,pagination:!0},on:{update:function(t){arguments[0]=t=e.$handleEvent(t),e.updateBtn.apply(void 0,arguments)},delete:function(t){arguments[0]=t=e.$handleEvent(t),e.deleteBtn.apply(void 0,arguments)},"current-change":function(t){arguments[0]=t=e.$handleEvent(t),e.currentChange.apply(void 0,arguments)},"selection-change":function(t){arguments[0]=t=e.$handleEvent(t),e.selectionChange.apply(void 0,arguments)}}}),a("dynamic-form-dialog",{attrs:{title:e.formDialog.title,"form-schema":e.formSchema,"form-type-code":e.formTypeCode,"initial-data":e.formDialog.data,butVisible:!0,saveLoading:e.saveFormLoading,submitLoading:e.submitFormLoading,simulateLoading:e.simulateFormLoading},on:{save:function(t){arguments[0]=t=e.$handleEvent(t),e.handleFormSave.apply(void 0,arguments)},submit:function(t){arguments[0]=t=e.$handleEvent(t),e.handleFormSubmit.apply(void 0,arguments)},simulate:function(t){arguments[0]=t=e.$handleEvent(t),e.handleSimulate.apply(void 0,arguments)},"preview-file":function(t){arguments[0]=t=e.$handleEvent(t),e.previewFile.apply(void 0,arguments)}},model:{value:e.formDialog.show,callback:function(t){e.$set(e.formDialog,"show",t)},expression:"formDialog.show"}}),a("simulate-handle-dialog",{attrs:{"simulate-data":e.simulateDialog.data},on:{submit:function(t){arguments[0]=t=e.$handleEvent(t),e.submitAfterSimulate.apply(void 0,arguments)}},model:{value:e.simulateDialog.show,callback:function(t){e.$set(e.simulateDialog,"show",t)},expression:"simulateDialog.show"}}),a("file-preview-dialog",{attrs:{"file-data":e.filePreview.data},on:{download:function(t){arguments[0]=t=e.$handleEvent(t),e.downloadFile.apply(void 0,arguments)}},model:{value:e.filePreview.show,callback:function(t){e.$set(e.filePreview,"show",t)},expression:"filePreview.show"}}),a("vk-data-dialog",{attrs:{title:e.detailDialog.title,width:"900px"},scopedSlots:e._u([{key:"footer",fn:function(){return[a("el-button",{on:{click:function(t){arguments[0]=t=e.$handleEvent(t),e.detailDialog.show=!1}}},[e._v("关闭")])]},proxy:!0}]),model:{value:e.detailDialog.show,callback:function(t){e.$set(e.detailDialog,"show",t)},expression:"detailDialog.show"}},[a("approve-header-detail",{attrs:{"detail-data":e.detailDialog.data,"form-schema":e.formSchema,"process-info":e.processInfo,"status-history":e.statusHistory,"current-tasks":e.detailDialog.currentTasks,"show-basic-info":!0,"show-return-info":!1,"show-approval-flow":!0,"show-current-task":!0,"show-handle-form":!1,"form-type-configs":e.formTypeConfigs},on:{"preview-file":function(t){arguments[0]=t=e.$handleEvent(t),e.previewFile.apply(void 0,arguments)},"download-file":function(t){arguments[0]=t=e.$handleEvent(t),e.downloadFile.apply(void 0,arguments)}}})],1)],1)},r=[]},"4f7f":function(e,t,a){var n=a("76eb");n.__esModule&&(n=n.default),"string"===typeof n&&(n=[[e.i,n,""]]),n.locals&&(e.exports=n.locals);var o=a("967d").default;o("fa5ee19c",n,!0,{sourceMap:!1,shadowMode:!1})},"5e82":function(e,t,a){"use strict";a.r(t);var n=a("3e25"),o=a("2b5e");for(var r in o)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return o[e]}))}(r);a("774e");var i=a("828b"),s=Object(i["a"])(o["default"],n["b"],n["c"],!1,null,"5b10aa68",null,!1,n["a"],void 0);t["default"]=s.exports},"76eb":function(e,t,a){var n=a("c86c");t=n(!1),t.push([e.i,".page-body[data-v-5b10aa68]{padding:%?20?%}.button-group[data-v-5b10aa68]{margin-bottom:%?20?%;padding:%?20?%;background:#fff;border-radius:%?8?%;-webkit-box-shadow:0 %?2?% %?6?% rgba(0,0,0,.1);box-shadow:0 %?2?% %?6?% rgba(0,0,0,.1)}",""]),e.exports=t},"774e":function(e,t,a){"use strict";var n=a("4f7f"),o=a.n(n);o.a},e8ff:function(e,t,a){"use strict";a("6a54");var n=a("f5bd").default;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,a("bf0f"),a("2797"),a("aa77"),a("fd3c"),a("dc8a"),a("c223"),a("5c47"),a("af8f"),a("aa9c"),a("4100"),a("4626"),a("5ac7"),a("9327"),a("0506");var o=n(a("9b1b")),r=n(a("2634")),i=n(a("2fdc")),s=n(a("5453")),l=n(a("413d")),u=n(a("7cf48")),c=n(a("57e1")),d=uni.vk,f={name:"SealApply",components:{DynamicFormDialog:s.default,SimulateHandleDialog:l.default,FilePreviewDialog:u.default,ApproveHeaderDetail:c.default},data:function(){var e=this;return{formDatas:{},loading:!0,addLoading:!1,refreshLoading:!1,saveFormLoading:!1,submitFormLoading:!1,simulateFormLoading:!1,deleteLoading:!1,formSchema:null,formTypeCode:"SEAL_APPLY",formTypeConfigs:{},formDialog:{show:!1,title:"",data:null},simulateDialog:{show:!1,data:null},filePreview:{show:!1,data:{url:"",name:"",type:""}},processInfo:{tasks:[],instance:null},table1:{action:"admin/bpmn/application-form/sys/getList",customRightBtns:[{title:"详细",icon:"el-icon-tickets",show:function(t){return e.$hasRole("admin")||e.$hasRole("group-common")},onClick:function(t){e.showDetail(t)}},{title:"编辑",type:"primary",icon:"el-icon-edit",show:function(t){return(e.$hasRole("admin")||e.$hasRole("group-common"))&&"draft"===t.status&&t.applicant_id===d.getVuex("$user.userInfo.username")},onClick:function(t){e.updateBtn({item:t})}},{title:"删除",type:"danger",icon:"el-icon-delete",show:function(t){return(e.$hasRole("admin")||e.$hasRole("group-common"))&&"draft"===t.status&&t.applicant_id===d.getVuex("$user.userInfo.username")},onClick:function(t){e.deleteBtn({item:t})}}],columns:[{key:"form_data.file_name",title:"文件名称",type:"text",width:200,showOverflowTooltip:!0},{key:"form_data.seal_type",title:"用印类型",type:"text",width:120,formatter:function(t){return e.getFieldOptionLabel("seal_type",t)||t}},{key:"form_data.file_type",title:"文件类型",type:"text",width:120,formatter:function(t){return e.getFieldOptionLabel("file_type",t)||t}},{key:"form_data.copies",title:"份数",type:"text",width:80},{key:"applicant_name",title:"申请人",type:"text",width:100},{key:"status",title:"状态",type:"tag",width:100,data:[{value:"draft",label:"草稿",tagType:"info"},{value:"pending",label:"待处理",tagType:"warning"},{value:"rejected",label:"已驳回",tagType:"danger"},{value:"withdrawn",label:"已撤回"},{value:"approved",label:"已通过",tagType:"success"}]},{key:"_add_time",title:"申请时间",type:"time",width:180}]},queryForm1:{formData:{form_type_code:"SEAL_APPLY",status:"pending"},columns:[{key:"form_type_code",title:"表单类型",type:"text",mode:"=",show:["none"]},{key:"status",title:"状态",type:"select",width:150,mode:"=",data:[{value:"draft",label:"草稿"},{value:"pending",label:"待处理"},{value:"rejected",label:"已驳回"},{value:"withdrawn",label:"已撤回"},{value:"approved",label:"已通过"}]},{key:"_add_time",title:"申请日期",type:"datetimerange",width:300,mode:"[]"}]},detailDialog:{show:!1,title:"用印申请详情",currentTasks:[],data:null},statusHistory:[]}},onLoad:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};d=this.vk,this.init(e)},methods:{openForm:function(e,t){this.vk;this.$set(this.formDatas,e,t)},init:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function e(){return(0,r.default)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,t.loading=!0,e.next=4,t.loadFormTypes();case 4:return e.next=6,t.getFormTypeSchema();case 6:e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](0),console.error("初始化失败:",e.t0),t.$message.error("页面初始化失败");case 12:return e.prev=12,t.loading=!1,e.finish(12);case 15:case"end":return e.stop()}}),e,null,[[0,8,12,15]])})))()},loadFormTypes:function(){var e=this;return(0,i.default)((0,r.default)().mark((function t(){var a,n;return(0,r.default)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,e.vk.callFunction({url:"admin/bpmn/form-type/sys/getList",data:{status:"active"}});case 3:a=t.sent,0===a.code&&a.rows&&(a.rows.forEach((function(t){e.formTypeConfigs[t.code]=t})),n=e.queryForm1.columns.find((function(e){return"form_type_code"===e.key})),n&&(n.data=a.rows.map((function(e){return{value:e.code,label:e.name}})))),t.next=10;break;case 7:t.prev=7,t.t0=t["catch"](0),console.error("加载表单类型失败:",t.t0);case 10:case"end":return t.stop()}}),t,null,[[0,7]])})))()},getFormTypeSchema:function(){var e=this;return(0,i.default)((0,r.default)().mark((function t(){var a;return(0,r.default)().wrap((function(t){while(1)switch(t.prev=t.next){case 0:try{a=e.formTypeConfigs[e.formTypeCode],a&&a.form_schema?(e.formSchema=JSON.parse(a.form_schema),e.initQueryFormOptions()):console.error("加载表单配置失败:",res.msg)}catch(n){console.error("加载表单配置失败:",n)}case 1:case"end":return t.stop()}}),t)})))()},initQueryFormOptions:function(){if(this.formSchema&&this.formSchema.fields){var e=this.formSchema.fields.find((function(e){return"seal_type"===e.name}));if(e&&e.options){var t=this.queryForm1.columns.find((function(e){return"form_data.seal_type"===e.key}));t&&(t.data=e.options)}}},addBtn:function(){this.formSchema?(this.formDialog={show:!0,title:"新建用印申请",data:{form_type_code:this.formTypeCode,form_data:{}}},this.openForm("formDialog",this.formDialog)):this.$message.warning("表单配置加载中，请稍后重试")},updateBtn:function(e){var t=e.item;if(this.formSchema){console.log("编辑数据:",t);var a=(0,o.default)({},t);t.form_data&&Object.keys(t.form_data).forEach((function(e){a[e]=t.form_data[e]})),console.log("重组后的数据:",a),this.formDialog={show:!0,title:"编辑用印申请",data:a},this.openForm("formDialog",this.formDialog)}else this.$message.warning("表单配置加载中，请稍后重试")},handleFormSave:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){var n,o;return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.saveFormLoading=!0,a.prev=1,n="admin/bpmn/application-form/sys/add",e._id&&(n="admin/bpmn/application-form/sys/update"),a.next=6,t.vk.callFunction({url:n,data:e});case 6:o=a.sent,0===o.code?(t.$message.success("保存成功"),t.formDialog.show=!1,t.refresh()):t.$message.error(o.msg||"保存失败"),a.next=14;break;case 10:a.prev=10,a.t0=a["catch"](1),console.error("保存失败:",a.t0),t.$message.error("保存失败");case 14:return a.prev=14,t.saveFormLoading=!1,a.finish(14);case 17:case"end":return a.stop()}}),a,null,[[1,10,14,17]])})))()},handleFormSubmit:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){var n,i,s,l,u;return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.submitFormLoading=!0,a.prev=1,n=d.getVuex("$user.userInfo"),i={file_count:1,total_pages:e.form_data.copies||1},s="".concat(n.username,"的").concat(t.getFieldOptionLabel("seal_type",e.form_data.seal_type),"用印申请"),l=(0,o.default)((0,o.default)({},e),{},{calculated_values:i,userInfo:n,title:s}),e._id&&(l._id=e._id,l.status="pending"),a.next=9,t.vk.callFunction({url:"admin/bpmn/application-form/pub/submit",data:l});case 9:u=a.sent,0===u.code?(t.$message.success("提交成功"),t.formDialog.show=!1,t.refresh()):t.$message.error(u.msg||"提交失败"),a.next=17;break;case 13:a.prev=13,a.t0=a["catch"](1),console.error("提交失败:",a.t0),t.$message.error("提交失败");case 17:return a.prev=17,t.submitFormLoading=!1,a.finish(17);case 20:case"end":return a.stop()}}),a,null,[[1,13,17,20]])})))()},handleSimulate:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){var n,o,i,s;return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.simulateFormLoading=!0,a.prev=1,n=d.getVuex("$user.userInfo"),o={file_count:1,total_pages:e.form_data.copies||1},i={form_type_code:t.formTypeCode,form_data:e.form_data,calculated_values:o,userInfo:n},a.next=7,t.vk.callFunction({url:"admin/bpmn/process-engine/pub/simulate",data:i});case 7:s=a.sent,0===s.code?t.showSimulateResult(s.data):t.$message.error(s.msg||"试算失败"),a.next=15;break;case 11:a.prev=11,a.t0=a["catch"](1),console.error("试算失败:",a.t0),t.$message.error("试算失败");case 15:return a.prev=15,t.simulateFormLoading=!1,a.finish(15);case 18:case"end":return a.stop()}}),a,null,[[1,11,15,18]])})))()},showSimulateResult:function(e){this.simulateDialog.data=e,this.simulateDialog.show=!0},submitAfterSimulate:function(){this.simulateDialog.show=!1,this.handleFormSubmit(this.formDialog.data)},getFieldOptionLabel:function(e,t){if(!this.formSchema||!this.formSchema.fields)return t;var a=this.formSchema.fields.find((function(t){return t.name===e}));if(!a||!a.options)return t;var n=a.options.find((function(e){return e.value===t}));return n?n.label:t},formatDate:function(e,t){return e?d.pubfn.timeFormat(e,t||"yyyy-MM-dd hh:mm:ss"):"-"},search:function(){this.$refs.table1.search()},refresh:function(){this.$refs.table1.refresh()},currentChange:function(e){this.table1.selectItem=e},selectionChange:function(e){this.table1.multipleSelection=e},showDetail:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.detailDialog.data=e,a.next=3,t.loadProcessFlow(e);case 3:return a.next=5,t.loadStatusHistory(e);case 5:t.detailDialog.show=!0;case 6:case"end":return a.stop()}}),a)})))()},loadProcessFlow:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){var n,o;return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,t.vk.callFunction({url:"admin/bpmn/task/pub/getProcessFlow",data:{formData:{application_id:e._id},userInfo:d.getVuex("$user.userInfo"),orderBy:"sequence asc"}});case 3:if(n=a.sent,0===n.code&&(t.processInfo.tasks=n.rows||[]),!e.process_instance_id){a.next=10;break}return a.next=8,t.vk.callFunction({url:"admin/bpmn/instance/sys/getList",data:{formData:{_id:e.process_instance_id}}});case 8:o=a.sent,0===o.code&&o.rows&&o.rows.length>0&&(t.processInfo.instance=o.rows[0]);case 10:a.next=15;break;case 12:a.prev=12,a.t0=a["catch"](0),console.error("加载审批流程失败:",a.t0);case 15:case"end":return a.stop()}}),a,null,[[0,12]])})))()},loadStatusHistory:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){var n;return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,t.statusHistory=[],t.statusHistory.push({action:"create",operation_time:e._add_time,operator_name:e.applicant_name,comment:"创建用印申请",task_name:"申请创建"}),a.next=5,t.vk.callFunction({url:"admin/bpmn/task-history/sys/getList",data:{formData:{application_id:e._id,action:"create"},orderBy:"operation_time asc"}});case 5:n=a.sent,0===n.code&&n.rows&&n.rows.forEach((function(e){t.statusHistory.push({action:e.action,operation_time:e.operation_time,operator_name:e.operator_name,comment:e.comment,task_name:t.getTaskNameFromHistory(e)})})),t.statusHistory.sort((function(e,t){return e.operation_time-t.operation_time})),a.next=14;break;case 10:a.prev=10,a.t0=a["catch"](0),console.error("加载状态历史失败:",a.t0),t.statusHistory=[{action:"create",operation_time:e._add_time,operator_name:e.applicant_name,comment:"创建用印申请",task_name:"申请创建"}];case 14:case"end":return a.stop()}}),a,null,[[0,10]])})))()},getTaskNameFromHistory:function(e){return e.task_data&&e.task_data.node_info?e.task_data.node_info.node_name:e.task_snapshot?e.task_snapshot.task_name:"任务处理"},deleteBtn:function(e){var t=this;return(0,i.default)((0,r.default)().mark((function a(){var n;return(0,r.default)().wrap((function(a){while(1)switch(a.prev=a.next){case 0:n=e.item,t.$confirm("确定删除该用印申请吗？","提示",{type:"warning"}).then((0,i.default)((0,r.default)().mark((function e(){var a;return(0,r.default)().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.deleteLoading=!0,e.prev=1,e.next=4,t.vk.callFunction({url:"admin/bpmn/application-form/sys/delete",data:{id:n._id}});case 4:a=e.sent,0===a.code?(t.$message.success("删除成功"),t.refresh()):t.$message.error(a.msg||"删除失败"),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](1),console.error("删除失败:",e.t0),t.$message.error("删除失败");case 12:return e.prev=12,t.deleteLoading=!1,e.finish(12);case 15:case"end":return e.stop()}}),e,null,[[1,8,12,15]])})))).catch((function(){t.deleteLoading=!1}));case 2:case"end":return a.stop()}}),a)})))()},previewFile:function(e){e&&e.url?(this.filePreview.data={url:e.url,name:e.name,type:this.getFileType(e)},this.filePreview.show=!0):this.$message.warning("文件地址无效")},downloadFile:function(e){if(e&&e.url){var t=document.createElement("a");t.href=e.url,t.download=e.name||"download",t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),this.$message.success("开始下载文件")}else this.$message.warning("文件地址无效")},getFileType:function(e){if(!e)return"unknown";var t=e.name||"",a=e.type||"";return a.includes("pdf")||t.toLowerCase().endsWith(".pdf")?"pdf":a.includes("image")||/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(t)?"image":a.includes("text")||/\.(txt|md)$/i.test(t)?"text":"other"}}};t.default=f}}]);